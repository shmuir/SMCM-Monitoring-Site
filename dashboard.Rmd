---
title: "SMCM DOCK MONITORING DASHBOARD"
output: 
  flexdashboard::flex_dashboard:
    theme: yeti
    logo:
    vertical_layout: scroll 
    runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(tidyverse)
library(googlesheets4)
library(viridisLite)
library(lubridate)
source("weather.R")

ysi_data <- read_sheet("https://docs.google.com/spreadsheets/d/19E9JgnPOJ6_OhN-Het-EC9rVEH-qPRPNovM0TV-f6lQ/edit?usp=sharing") %>%
  mutate(sample_time = format(sample_time,"%H:%M:%S"))

nutrient_data <- read_sheet("https://docs.google.com/spreadsheets/d/1ywOnrc0v4ZvZrWyQ9-EZjXdom1vREmvO7BC4zhhsg1I/edit?usp=sharing") %>%
  mutate(sample_time = format(sample_time,"%H:%M:%S"),
         date_time = ymd_hms(paste(sample_date, sample_time))) %>%
  pivot_longer(., 4:7, names_to = "nutrient") %>%
  rename(mg_l = value)

nutrient_dattab <- read_sheet("https://docs.google.com/spreadsheets/d/1ywOnrc0v4ZvZrWyQ9-EZjXdom1vREmvO7BC4zhhsg1I/edit?usp=sharing") %>%
  mutate(sample_time = format(sample_time,"%H:%M:%S"),
         date_time = ymd_hms(paste(sample_date, sample_time)))

weather_data <- read_rds("weather-smcmdock.rds")
```

# OVERVIEW 

#### WELCOME TO THE SMCM DOCK MONITORING DASHBOARD!

```{r, echo = F, out.width = '100%', fig.align = 'center'}
knitr::include_graphics('www/river_pan.JPG')
```

say some stuff


# METHODS

### YSI Sampling

Talk about it here

```{r}
#show picture of YSI
#knitr::include_graphics()
```



### Nutrient Sampling

Talk about it here

```{r}
#show picture
#knitr::include_graphics()
```


# YSI {data-navmenu="VISUALIZATIONS"}

## Column {.sidebar}

```{r}
# creating a sidebar where the user can choose which country they want to view
select_values <- colnames(ysi_data)
select_values <- select_values[select_values %in% 
                                 c('salinity', "ph", "temp_c", "do_percent", "do_mg_l", "salinity")]


selectInput(
    "y_var",
    label = "Y Variable",
    choices = select_values,
    selected = 'sample_date')

  dateRangeInput("sample_date",
                 "Select a Date Range",
                 start = "2022-05-25")
```

## Column {data-width="1000"}

```{r echo=FALSE}
renderPlot({
  ysi_data %>%
    filter(sample_date >= as.Date(input$sample_date[1]),
           sample_date <= as.Date(input$sample_date[2])) %>%
    ggplot(.,aes_string(x = "sample_date", y = input$y_var, color = "depth_m")) +
    geom_point(size = 2.5) +
    geom_line() +
    labs(x = "") +
    theme_linedraw() +
    scale_color_viridis_d()
})

DT::renderDataTable({
    
    
    ysi_table <- ysi_data %>% 
      select(sample_date, salinity, ph, temp_c, do_percent, do_mg_l)
    
    
    DT::datatable(ysi_table,
                  extensions = "Scroller",
                  filter = "top", options = list(
                    deferRender = TRUE,
                    scrollY = 200,
                    scroller = TRUE
                  ),
                  rownames = FALSE,
                  colnames = c("Date",
                               "Salinity",
                               "ph",
                               "Temperature (ºC)",
                               "DO Percent",
                               "DO (mg/l)")
    )
    
  }) 
```

# NUTRIENTS {data-navmenu="VISUALIZATIONS"}

## Column {.sidebar}

```{r}
dateRangeInput("date_time",
                 "Select a Date Range",
                 start = "2022-06-28")
```

## Column {data-width="1000"}

```{r}
renderPlot({
  nutrient_data %>%
    filter(date_time >= as.Date(input$date_time[1]),
           date_time <= as.Date(input$date_time[2])) %>%
    ggplot(., aes_string(x="date_time", y="mg_l", color = "nutrient")) +
      geom_point(size = 2.5) +
      geom_line() +
      labs(x="", y="mg/l") +
      theme_linedraw() +
      scale_color_viridis_d()
    
  })
  
 DT::renderDataTable({
    
    nutrient_tab <- nutrient_dattab %>% 
      select(date_time, nh3_mg_l, no3_l_mg_l, no3_m_mg_l, po4_mg_l)
    
    
    DT::datatable(nutrient_tab,
                  extensions = "Scroller",
                  filter = "top", options = list(
                    deferRender = TRUE,
                    scrollY = 200,
                    scroller = TRUE
                  ),
                  rownames = FALSE,
                  colnames = c("Date",
                               "NH3",
                               "NO3 low",
                               "NO3 high", 
                               "PO4")
    )
    
  }) 
```


# CURRENT WEATHER {data-navmenu="WEATHER"}

```{r}
observe({ 
      weather <<- paste0("https://tempestwx.com/station/69060/")
    })
    output$frame <- renderUI({
      dock_weather <- tags$iframe(src=weather, height=600, width=600)
      print(dock_weather)
      dock_weather
    })
```


# WEATHER HISTORY {data-navmenu="WEATHER"}


```{r}
weather_select <- colnames(weather_data)
weather_select <- weather_select[weather_select %in% 
                                 c('wind_avg', "wind_mph", "pressure", "airtemp", "rel_hum", "illum", "uv_index", "solar_rad", "rain_accum","day_rain_accum", "strike_ct")]
  
  selectInput(
    "y_variable",
    label = "Y Variable",
    choices = weather_select,
    selected = 'date')
  
  dateRangeInput("date",
                 "Select a Date Range",
                 start = "2022-05-25")
```


```{r}
renderPlot({
  weather_data %>%
    filter(date >= as.Date(input$date[1]),
           date <= as.Date(input$date[2])) %>%
    ggplot(., aes_string(x="date", y=input$y_variable)) +
      geom_point() +
      geom_line() +
      labs(x="", y=input$y_variable) +
      theme_light() +
      scale_color_viridis_d()
    
  })
  
DT::renderDataTable({
    weather_table <- weather_data %>% 
      select(datetime, wind_avg, pressure, airtemp, rel_hum, illum, uv_index, solar_rad, rain_accum, day_rain_accum, strike_ct)
    
    
  DT::datatable(weather_table,
                  extensions = "Scroller",
                  options = list(
                    deferRender = TRUE,
                    scrollY = 200,
                    scroller = TRUE
                  ),
                  rownames = FALSE,
                  colnames = c("Date",
                               "Wind Avg. (mph)",
                               "Pressure (Pa)",
                               "Air Temperature (ºC)",
                               "Humidity",
                               "Illum",
                               "UV Index",
                               "Solar Radiation",
                               "Rain Accumulation",
                               "Daily Rain Accumulation",
                               "Lightening Strikes")
    )
    
  }) 
```

